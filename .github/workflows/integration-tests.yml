name: Parameterized Integration Tests

on:
  workflow_call:
    inputs:
      java-version:
        type: string
        required: true
      kube-version:
        type: string
        required: true
      http-client:
        type: string
        required: false
        default: 'vertx'
      experimental:
        type: boolean
        required: false
        default: false
      checkout-ref:
        type: string
        required: false
        default: ''

jobs:
  integration_tests:
    name: |
      Integration tests:
      JDK: ${{ inputs.java-version }}
      Kube: ${{ inputs.kube-version }}
      Experimental: ${{ inputs.experimental }}
      Checkout ref: ${{ inputs.checkout-ref }}
    runs-on: ubuntu-latest
    continue-on-error: ${{ inputs.experimental }}
    timeout-minutes: 180
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ inputs.checkout-ref }}
      - name: Set up Java and Maven
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ inputs.java-version }}
          cache: 'maven'
      - name: Set up Minikube
        uses: manusa/actions-setup-minikube@v2.13.1
        with:
          minikube version: 'v1.34.0'
          kubernetes version: '${{ inputs.kube-version }}'
          driver: 'docker'
          github token: ${{ secrets.GITHUB_TOKEN }}
      - name: "Run tests"
        run: |
          echo "Running tests..."
          ./mvnw ${MAVEN_ARGS} -T1C -B install -DskipTests --file pom.xml
          
          echo "Running baseapi integration tests with the default HTTP client..."
          ./mvnw ${MAVEN_ARGS} -T1C -B package -Pintegration-tests-baseapi --file pom.xml
          
          echo "Running dependent integration tests with the default HTTP client..."
          ./mvnw ${MAVEN_ARGS} -T1C -B package -Pintegration-tests-dependent --file pom.xml
          
          echo "Running workflow integration tests with the default HTTP client..."
          ./mvnw ${MAVEN_ARGS} -T1C -B package -Pintegration-tests-workflow --file pom.xml
          
          echo "Running minimal-watch-timeout-dependent-it integration tests with the default HTTP client..."
          ./mvnw ${MAVEN_ARGS} -T1C -B package -Pminimal-watch-timeout-dependent-it --file pom.xml
          
          echo "Running all integration tests with the default HTTP client..."
          ./mvnw ${MAVEN_ARGS} -T1C -B package -Pintegration-tests --file pom.xml
          
          echo "Running baseapi integration tests with the Vert.x HTTP client..."
          ./mvnw ${MAVEN_ARGS} -T1C -B package -Pintegration-tests-baseapi -Dfabric8-httpclient-impl.name=vertx --file pom.xml
          
          echo "Running baseapi integration tests with the JDK HTTP client..."
          ./mvnw ${MAVEN_ARGS} -T1C -B package -Pintegration-tests-baseapi -Dfabric8-httpclient-impl.name=jdk --file pom.xml
          
          echo "Running baseapi integration tests with the Jetty HTTP client..."
          ./mvnw ${MAVEN_ARGS} -T1C -B package -Pintegration-tests-baseapi -Dfabric8-httpclient-impl.name=jetty --file pom.xml
          

